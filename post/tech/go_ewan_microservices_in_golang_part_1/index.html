<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>[译]用GoLang实现微服务（一） - 二向箔</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Ewan Valentine" /><meta name="description" content="系列文章的第一篇，讲述用Go实现微服务，同时会用到诸如Docker, Kubernetes, CircleCI, go-micro, MongoDB等技术" /><meta name="keywords" content="golang, microservices, google, go, programming, grpc, protobuf, prot, proto" />






<meta name="generator" content="Hugo 0.86.0 with theme even" />


<link rel="canonical" href="https://blog.dingkewz.com/post/tech/go_ewan_microservices_in_golang_part_1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="[译]用GoLang实现微服务（一）" />
<meta property="og:description" content="系列文章的第一篇，讲述用Go实现微服务，同时会用到诸如Docker, Kubernetes, CircleCI, go-micro, MongoDB等技术" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.dingkewz.com/post/tech/go_ewan_microservices_in_golang_part_1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-03-26T20:19:00+08:00" />
<meta property="article:modified_time" content="2018-04-07T20:19:00+08:00" />

<meta itemprop="name" content="[译]用GoLang实现微服务（一）">
<meta itemprop="description" content="系列文章的第一篇，讲述用Go实现微服务，同时会用到诸如Docker, Kubernetes, CircleCI, go-micro, MongoDB等技术"><meta itemprop="datePublished" content="2018-03-26T20:19:00+08:00" />
<meta itemprop="dateModified" content="2018-04-07T20:19:00+08:00" />
<meta itemprop="wordCount" content="4887">
<meta itemprop="keywords" content="Golang,翻译,Docker,Kubernetes,CI,Microservice_Golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[译]用GoLang实现微服务（一）"/>
<meta name="twitter:description" content="系列文章的第一篇，讲述用Go实现微服务，同时会用到诸如Docker, Kubernetes, CircleCI, go-micro, MongoDB等技术"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">二向箔</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">二向箔</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">[译]用GoLang实现微服务（一）</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-03-26 </span>
        <div class="post-category">
            <a href="/categories/%E6%8A%80%E6%9C%AF/"> 技术 </a>
            </div>
          <span class="more-meta"> 约 4887 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#文章">文章</a></li>
    <li><a href="#书籍">书籍</a></li>
    <li><a href="#podcasts">Podcasts</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><strong><em>此系列文章介绍如何用GoLang实践微服务, 分十篇。此为其首。</em></strong><br>
<strong><em>原著作者：<a href="https://ewanvalentine.io/">Ewan Valentine</a></em></strong><br>
<strong><em>原文连接：<a href="https://ewanvalentine.io/microservices-in-golang-part-1/">https://ewanvalentine.io/microservices-in-golang-part-1/</a></em></strong> <br>
<strong><em>友情提示：系列文章的后五篇翻译请移步至<a href="https://wuyin.io">wuYin&rsquo;s blog</a></em></strong></p>
<p><em><del>初稿</del> -&gt; 润色</em></p>
<h1 id="导言">导言</h1>
<p>在本文中，我们将了解一些基础的概念，术语。同时将创建我们的第一个微服务，尽管它会非常简陋。</p>
<p>在接下来的文章中，我们会陆续创建以下微服务:</p>
<ul>
<li>consignments (货运)</li>
<li>inventory (仓库)</li>
<li>users (用户)</li>
<li>authentication (认证)</li>
<li>roles (角色)</li>
<li>vessels (货船)</li>
</ul>
<p>完整的技术栈如下：golang, mongodb, grpc, docker, Google Cloud, Kubernetes, NATS, CircleCI, Terrafrom and go-micro.</p>
<p>在你跟随此文学习时，请务必设置合适的GOPATH，以及使用这个<a href="https://github.com/EwanValentine/shippy">git仓库</a>(每篇文章对应一个分支)。</p>
<p>另外，我的工作平台是Macbook，所以如果你的工作平台有所不同，那么文章中的些许地方需要相应的改动，比如Makefiles中的<code>$GOPATH</code>和<code>$(GOPATH)</code>，请您自行关注。</p>
<h1 id="必要准备">必要准备</h1>
<ul>
<li>了解Golang和它的生态圈</li>
<li>安装gRPc/protobuf - <a href="https://grpc.io/docs/quickstart/go.html">教程在此</a></li>
<li>安装Golang - <a href="https://golang.org/doc/install">教程在此</a></li>
<li>安装以下库</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u google.golang.org/grpc
go get -u github.com/golang/protobuf/protoc-gen-go
</code></pre></div><h1 id="我们要写一个怎样的项目">我们要写一个怎样的项目？</h1>
<p>我们要写一个简单的集装箱管理平台。之所以选择它，当然是因为它有一定的复杂性，可以展示微服务的作用，毕竟用微服务来实现一个博客真是大材小用了。好了，让我们开始吧！</p>
<h1 id="何为微服务">何为微服务？</h1>
<p>在传统的应用中，所有的功能都是存在于单一的代码库(Monotholic Code Base)中。在表面上看，代码库中的代码可以有几种聚合方式。可能会按照其类型分割，比如controllers, entity, factories，也有可能按照其功能拆分成几个包，比如auth, articles等等。但无论如何，整个应用是建立在一个单一代码库上的。</p>
<p>微服务是对于上述第二种聚合方式的拓展。我们依旧将应用按照其功能拆分成几个包，但不同的是，这些功能包现在都是一个可独立运行的代码库。</p>
<h1 id="为何用微服务">为何用微服务？</h1>
<p>降低复杂性 - 将功能拆分成对应的微服务可以将你的整个代码拆分成更小，更易维护的代码库。这有点类似早期Unix的开发哲学“只做一件事，并做到做好“。在传统的单一代码库应用中，代码的耦合性往往更容易往高耦合发展。这就可能导致撰写和维护代码变得很复杂，也更容易出现漏洞。</p>
<p>拓展性 - 在单一代码库应用中，可能某些代码的使用频率会比其他代码高很多。当出现需要拓展我们的应用时，我们此时只能拓展整个代码库而非其中的部分代码。比如现在应用的瓶颈出现在了验证模块上，由于验证模块是和整个应用的代码库高度耦合的，那么我们只能选择拓展整个代码库来摆脱瓶颈。但如果验证模块本身是一个微服务，那么我们只需要拓展验证模块即可。</p>
<p>微服务的理念让你能撰写低耦合的代码，这样更容易横向拓展，这非常适合于如今云端的开发环境。</p>
<p><strong>Nginx有一系列文章来探讨了有关微服务的诸多概念，可以<a href="https://www.nginx.com/blog/introduction-to-microservices/">在此阅读</a>。</strong></p>
<h1 id="为何选用golang">为何选用Golang?</h1>
<p>尽管很多语言都能实现微服务（毕竟微服务只是一种概念而非具体的框架），但有些语言对于微服务的支持会更好。Golang就是其中之一。</p>
<p>Golang本身非常的轻量，速度飞快。最重要的是，它对并发提供了非常好的支持，这一点能更好的利用多核处理器，以及帮助我们同时在不同的机器上运行代码。</p>
<p>Golang的标准库对网络服务有非常好的支持。</p>
<p>最后，Golang有一个非常棒的微服务框架，go-mirco，我们将在以后用到他。</p>
<h1 id="何为protobufgrpc">何为protobuf/gRPC</h1>
<p>由于每个微服务对应一个独立运行的代码库，一个很自然的问题就是如何在这些微服务之间通信。</p>
<p>我们可以使用传统的REST，用http传输JSON或者XML。但用这种方法的一个问题在于，当两个微服务A和B之间要通信时，A要先把数据编码成JSON/XML，然后发送一个大字符串给B，然后B在将数据从JSON/XML解码。这在大型应用中可能会造成大量的开销。尽管我们在和浏览器交互时必须使用这种方法，但微服务之间可以选择其他方式。</p>
<p>gRPC就是这另外一种方式。gRPC是谷歌出品的一个RPC通信工具，它很轻量，且其协议是基于二进制的。让我们来仔细研究下这个定义。gRPC将二进制当作其核心的编码格式。在我们使用JSON的RESTful例子中，我们的数据会以字符串的格式通过http传输。字符串包含了相对大量的元数据，用于描述其编码格式，长度，内容格式以及其他必要数据。之所以包含这些元数据，是因为要让传统的网页浏览器知道收到的数据会是怎样的。但是在两个微服务之间通信时，我们不一定需要这么多元数据。我们可以只需要更轻量的二进制数据。gRPC支持全新的HTTP 2协议，正好可以使用二进制数据。gRPC甚至可以建立双向的流数据。HTTP 2是gRPC的基础，如果你想了解更多HTTP 2的内容，可以看<a href="https://developers.google.com/web/fundamentals/performance/http2/">Google的这篇文章</a>。</p>
<p>那么我们该怎么用二进制数据呢？gRPC使用protobuf来描述数据格式。使用Protobuf，你可以清晰的定义一个微服务的界面。关于gRPC，我建议你读一读<a href="https://blog.gopheracademy.com/advent-2017/go-grpc-beyond-basics/">这篇文章</a>。</p>
<p>那么现在让我们开始定义第一个微服务吧。在你项目的根目录下建立以下文件<code>consignment-service/proto/consignment/consignment.proto</code>。值得一提的是，目前我会把所有的微服务代码放在一个统一的项目下。这种项目结构被称为&quot;mono-repo&quot;。之所以采用这种结构，只是想让教学更加简单。网络上有许多针对这种项目结构的争论，在此就不细究了。如果你喜欢，你当然也可以把每个微服务独立成一个新的项目。</p>
<p><code>consignment.proto</code>的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#75715e">// consignment-service/proto/consignment/consignment.proto
</span><span style="color:#75715e"></span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> go<span style="color:#f92672">.</span>micro.srv.consignment; <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> ShippingService {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> CreateConsignment(Consignment) <span style="color:#66d9ef">returns</span> (Response) {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Consignment</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> description <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> Container containers <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> vessel_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Container</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> customer_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> origin <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> user_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Response</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">bool</span> created <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  Consignment consignment <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>尽管这是一个非常简单的例子，但这里有几点需要注意。首先，你得定义<code>service</code>。一个<code>service</code>定义了此服务暴露给外界的交互界面。然后，你得定义<code>message</code>。宽泛的讲，<code>message</code>就是你的数据结构</p>
<p>这个文件里，<code>message</code>由protobuf处理，而<code>service</code>则是由protobuf的grpc插件处理。这个grpc插件使我们定义的<code>service</code>能使用<code>message</code>。</p>
<p>有了这个proto文件还不够，我们需要使用protobuf的工具来编译它。为了方便，让我们写一个<code>Makefile</code>来帮助我们编译文件。<code>consignment-service/Makefile</code>内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile"><span style="color:#a6e22e">build</span><span style="color:#f92672">:</span>
	protoc -I. --go_out<span style="color:#f92672">=</span>plugins<span style="color:#f92672">=</span>grpc:<span style="color:#66d9ef">$(</span>GOPATH<span style="color:#66d9ef">)</span>/src/github.com/ewanvalentine/shipper/consignment-service <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	  proto/consignment/consignment.proto
</code></pre></div><p>这段代码会调用protoc，它负责将我们的protobuf文件编译成代码。同时我们还指定了grpc的插件，以及最终输出文件的位置。</p>
<p>现在，如果你运行<code>$ make build</code>，然后前往文件夹<code>proto/consignment</code>，你应该可以看到一个新的Golang文件<code>consignment.pb.go</code>。这个文件是protoc自动生成的，它将proto文件中的<code>service</code>转化成了需要我们在Golang代码中需要编写的<code>interface</code>。</p>
<p>让我们现在来满足这个<code>interface</code>。创建<code>consignment-service/main.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// consignment-service/main.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;net&#34;</span>

    <span style="color:#75715e">// 导入生成的consignment.pb.go文件
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/ewanvalentine/shipper/consignment-service/proto/consignment&#34;</span>
    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
    <span style="color:#e6db74">&#34;google.golang.org/grpc/reflection&#34;</span>
    )

<span style="color:#66d9ef">const</span> (
    <span style="color:#a6e22e">port</span> = <span style="color:#e6db74">&#34;:50051&#34;</span>
    )

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IRepository</span> <span style="color:#66d9ef">interface</span> {
  <span style="color:#a6e22e">Create</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// Repository - 模拟一个数据库，我们会在此后使用真正的数据库替代他
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Repository</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">consignments</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Repository</span>) <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">consignment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>, <span style="color:#66d9ef">error</span>) {
<span style="color:#a6e22e">updated</span> <span style="color:#f92672">:=</span> append(<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">consignments</span>, <span style="color:#a6e22e">consignment</span>)
           <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">consignments</span> = <span style="color:#a6e22e">updated</span>
           <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">consignment</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// service要实现在proto中定义的所有方法。当你不确定时
</span><span style="color:#75715e">// 可以去对应的*.pb.go文件里查看需要实现的方法及其定义
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">service</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">IRepository</span>
}

<span style="color:#75715e">// CreateConsignment - 在proto中，我们只给这个微服务定一个了一个方法
</span><span style="color:#75715e">// 就是这个CreateConsignment方法，它接受一个context以及proto中定义的
</span><span style="color:#75715e">// Consignment消息，这个Consignment是由gRPC的服务器处理后提供给你的
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">CreateConsignment</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>) {

  <span style="color:#75715e">// 保存我们的consignment
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">consignment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">req</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }

  <span style="color:#75715e">// 返回的数据也要符合proto中定义的数据结构
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Created</span>: <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">Consignment</span>: <span style="color:#a6e22e">consignment</span>}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {

<span style="color:#a6e22e">repo</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Repository</span>{}

      <span style="color:#75715e">// 设置gRPC服务器
</span><span style="color:#75715e"></span>      <span style="color:#a6e22e">lis</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">port</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
          <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to listen: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        }
<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>()

     <span style="color:#75715e">// 在我们的gRPC服务器上注册微服务，这会将我们的代码和*.pb.go中
</span><span style="color:#75715e"></span>     <span style="color:#75715e">// 的各种interface对应起来
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterShippingServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">service</span>{<span style="color:#a6e22e">repo</span>})

     <span style="color:#75715e">// 在gRPC服务器上注册reflection
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">reflection</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span>)
     <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">lis</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
       <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to serve: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
     }
}
</code></pre></div><p>总的来说，我们实现了consignment微服务所需要的方法，并建立了一个服务器监听50051端口。如果你此时运行<code>go run main.go</code>，你肯定看不见任何输出，因为我们还没写客户端代码呢！</p>
<p>现在就让我们看看怎么写客户端代码。在这里我们要一个命令行工具, 它会读取JSON文件并和我们的服务器交互。</p>
<p>请在项目的根目录下建立一个新的文件夹<code>mkdir consingment-cli</code>。在这个文件夹中，我们创建<code>cli.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// consignment-cli/cli.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;encoding/json&#34;</span>
    <span style="color:#e6db74">&#34;io/ioutil&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;os&#34;</span>

    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/ewanvalentine/shipper/consignment-service/proto/consignment&#34;</span>
    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
    )

<span style="color:#66d9ef">const</span> (
    <span style="color:#a6e22e">address</span>         = <span style="color:#e6db74">&#34;localhost:50051&#34;</span>
    <span style="color:#a6e22e">defaultFilename</span> = <span style="color:#e6db74">&#34;consignment.json&#34;</span>
    )

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parseFile</span>(<span style="color:#a6e22e">file</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">consignment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>
    <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">file</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
  <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">consignment</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">consignment</span>, <span style="color:#a6e22e">err</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
  <span style="color:#75715e">// Set up a connection to the server.
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithInsecure</span>())
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Did not connect: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
    <span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">NewShippingServiceClient</span>(<span style="color:#a6e22e">conn</span>)

    <span style="color:#75715e">// Contact the server and print out its response.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">file</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">defaultFilename</span>
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>) &gt; <span style="color:#ae81ff">1</span> {
      <span style="color:#a6e22e">file</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>]
    }

  <span style="color:#a6e22e">consignment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseFile</span>(<span style="color:#a6e22e">file</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Could not parse file: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }

  <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CreateConsignment</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">consignment</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Could not greet: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Created: %t&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Created</span>)
}
</code></pre></div><p>现在让我们创建一个<code>consignment-cli/consignment.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;This is a test consignment&#34;</span>,
  <span style="color:#f92672">&#34;weight&#34;</span>: <span style="color:#ae81ff">550</span>,
  <span style="color:#f92672">&#34;containers&#34;</span>: [
    { <span style="color:#f92672">&#34;customer_id&#34;</span>: <span style="color:#e6db74">&#34;cust001&#34;</span>, <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;user001&#34;</span>, <span style="color:#f92672">&#34;origin&#34;</span>: <span style="color:#e6db74">&#34;Manchester, United Kingdom&#34;</span> }
  ],
  <span style="color:#f92672">&#34;vessel_id&#34;</span>: <span style="color:#e6db74">&#34;vessel001&#34;</span>
}
</code></pre></div><p>在<code>consignment-service</code>下运行<code>go run main.go</code>, 在另一个终端中，在<code>consignment-cli</code>下运行<code>go run cli.go</code>, 你应该能看到一条消息说<code>Created: true</code>。我们怎么确定一个<code>consignment</code>真的被创建了呢？让我们更新一下我们的微服务，加入一个<code>GetConsignments</code>方法，这样，我们就能看到所有存在的<code>consignment</code>了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-proto" data-lang="proto"><span style="color:#75715e">// consignment-service/proto/consignment/consignment.proto
</span><span style="color:#75715e"></span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> go<span style="color:#f92672">.</span>micro.srv.consignment;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> ShippingService {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> CreateConsignment(Consignment) <span style="color:#66d9ef">returns</span> (Response) {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// Created a new method
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">rpc</span> GetConsignments(GetRequest) <span style="color:#66d9ef">returns</span> (Response) {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Consignment</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> description <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> Container containers <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> vessel_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Container</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> customer_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> origin <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> user_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// Created a blank get request
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">GetRequest</span> {}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Response</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">bool</span> created <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  Consignment consignment <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// Added a pluralised consignment to our generic response message
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">repeated</span> Consignment consignments <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>现在运行<code>make build</code>来获得最新编译后的微服务界面。如果此时你运行<code>go run main.go</code>，你会获得一个类似这样的错误信息: <code>*service does not implement go_micro_srv_consignment.ShippingServiceServer (missing GetConsignments method)</code>。熟悉Go的你肯定知道，你忘记实现一个<code>interface</code>所需要的方法了。让我们更新<code>consignment-service/main.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>

	<span style="color:#75715e">// Import the generated protobuf code
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/ewanvalentine/shipper/consignment-service/proto/consignment&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
	<span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
	<span style="color:#e6db74">&#34;google.golang.org/grpc/reflection&#34;</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">port</span> = <span style="color:#e6db74">&#34;:50051&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IRepository</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">GetAll</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>
}

<span style="color:#75715e">// Repository - Dummy repository, this simulates the use of a datastore
</span><span style="color:#75715e">// of some kind. We&#39;ll replace this with a real implementation later on.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Repository</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">consignments</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Repository</span>) <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">consignment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">updated</span> <span style="color:#f92672">:=</span> append(<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">consignments</span>, <span style="color:#a6e22e">consignment</span>)
	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">consignments</span> = <span style="color:#a6e22e">updated</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">consignment</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Repository</span>) <span style="color:#a6e22e">GetAll</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">consignments</span>
}

<span style="color:#75715e">// Service should implement all of the methods to satisfy the service
</span><span style="color:#75715e">// we defined in our protobuf definition. You can check the interface
</span><span style="color:#75715e">// in the generated code itself for the exact method signatures etc
</span><span style="color:#75715e">// to give you a better idea.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">service</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">IRepository</span>
}

<span style="color:#75715e">// CreateConsignment - we created just one method on our service,
</span><span style="color:#75715e">// which is a create method, which takes a context and a request as an
</span><span style="color:#75715e">// argument, these are handled by the gRPC server.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">CreateConsignment</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Consignment</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>) {

	<span style="color:#75715e">// Save our consignment
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">consignment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">req</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// Return matching the `Response` message we created in our
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// protobuf definition.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Created</span>: <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">Consignment</span>: <span style="color:#a6e22e">consignment</span>}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">GetConsignments</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GetRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">consignments</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetAll</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Consignments</span>: <span style="color:#a6e22e">consignments</span>}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {

	<span style="color:#a6e22e">repo</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Repository</span>{}

	<span style="color:#75715e">// Set-up our gRPC server.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lis</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">port</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to listen: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>()

	<span style="color:#75715e">// Register our service with the gRPC server, this will tie our
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// implementation into the auto-generated interface code for our
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// protobuf definition.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterShippingServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">service</span>{<span style="color:#a6e22e">repo</span>})

	<span style="color:#75715e">// Register reflection service on gRPC server.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">reflection</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">lis</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to serve: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
}
</code></pre></div><p>如果现在使用<code>go run main.go</code>，一切应该正常。</p>
<p>最后让我们更新<code>consignment-cli/cli.go</code>来获得<code>consignment</code>信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#f92672">...</span> 

	<span style="color:#a6e22e">getAll</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">GetConsignments</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">GetRequest</span>{})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Could not list consignments: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">getAll</span>.<span style="color:#a6e22e">Consignments</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span>)
	}
}
</code></pre></div><p>此时再运行<code>go run cli.go</code>，你应该能看到所创建的所有<code>consignment</code>。</p>
<p>至此，我们使用protobuf和grpc创建了一个微服务以及一个客户端。在下一篇文章中，我们将介绍使用<code>go-micro</code>框架，以及创建我们的第二个微服务。同时在下一篇文章中，我们将介绍如何容Docker来容器化我们的微服务。</p>
<p>如果你觉得这篇文章对你有所帮助，你可以请原作者喝杯咖啡！链接如下：<a href="https://monzo.me/ewanvalentine">https://monzo.me/ewanvalentine</a></p>
<h1 id="一些有用的资源">一些有用的资源</h1>
<h2 id="文章">文章</h2>
<p><a href="https://www.nginx.com/blog/introduction-to-microservices/">https://www.nginx.com/blog/introduction-to-microservices/</a></p>
<p><a href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html</a></p>
<p><a href="https://www.microservices.com/talks/">https://www.microservices.com/talks/</a></p>
<p><a href="https://medium.facilelogin.com/ten-talks-on-microservices-you-cannot-miss-at-any-cost-7bbe5ab7f43f#.ui0748oat">https://medium.facilelogin.com/ten-talks-on-microservices-you-cannot-miss-at-any-cost-7bbe5ab7f43f#.ui0748oat</a></p>
<p><a href="https://microserviceweekly.com/">https://microserviceweekly.com/</a></p>
<h2 id="书籍">书籍</h2>
<p><a href="https://www.amazon.co.uk/Building-Microservices-Sam-Newman/dp/1491950358">https://www.amazon.co.uk/Building-Microservices-Sam-Newman/dp/1491950358</a></p>
<p><a href="https://www.amazon.co.uk/Devops-Handbook-World-Class-Reliability-Organizations/dp/1942788002">https://www.amazon.co.uk/Devops-Handbook-World-Class-Reliability-Organizations/dp/1942788002</a></p>
<p><a href="https://www.amazon.co.uk/Phoenix-Project-DevOps-Helping-Business/dp/0988262509">https://www.amazon.co.uk/Phoenix-Project-DevOps-Helping-Business/dp/0988262509</a></p>
<h2 id="podcasts">Podcasts</h2>
<p><a href="https://softwareengineeringdaily.com/tag/microservices/">https://softwareengineeringdaily.com/tag/microservices/</a></p>
<p><a href="https://martinfowler.com/tags/podcast.html">https://martinfowler.com/tags/podcast.html</a></p>
<p><a href="https://www.infoq.com/microservices/podcasts/">https://www.infoq.com/microservices/podcasts/</a></p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Ewan Valentine</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-04-07
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">Golang</a>
          <a href="/tags/%E7%BF%BB%E8%AF%91/">翻译</a>
          <a href="/tags/docker/">Docker</a>
          <a href="/tags/kubernetes/">Kubernetes</a>
          <a href="/tags/ci/">CI</a>
          <a href="/tags/microservice_golang/">Microservice_Golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/tech/go_ewan_microservices_in_golang_part_2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">[译]用GoLang实现微服务（二）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/tech/nodejs_04_process_binding/">
            <span class="next-text nav-default">[NodeJS源码探秘]之process.binding()</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/DingDean" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/deanacroic" class="iconfont icon-douban" title="douban"></a>
  <a href="https://blog.dingkewz.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>丁科</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?4f291681012b4d621f71f4207e8964e4";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
